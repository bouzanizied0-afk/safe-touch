<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>⏳ Temporal Pulse - Binary Stream</title>
    <style>
        body { background: #000; color: #0f0; font-family: 'Courier New', monospace; text-align: center; padding: 10px; margin: 0; }
        #global-tick { font-size: 40px; color: #0f0; text-shadow: 0 0 10px #0f0; margin: 10px; }
        #chat-display { 
            width: 95%; max-width: 700px; height: 400px; 
            border: 1px solid #003300; margin: 15px auto; 
            background: #050505; overflow-y: auto; padding: 15px;
            text-align: right; border-radius: 8px; box-shadow: inset 0 0 20px #000;
        }
        .input-area { margin-top: 10px; background: #0a0a0a; padding: 15px; border-top: 1px solid #003300; }
        input[type=text] { 
            width: 80%; padding: 12px; background: #000; 
            border: 1px solid #0f0; color: #0f0; outline: none; margin-bottom: 10px;
        }
        button { padding: 10px 20px; background: #001a00; color: #0f0; border: 1px solid #0f0; cursor: pointer; font-weight: bold; transition: 0.3s; }
        button:hover { background: #00ff00; color: #000; }
        .del-btn { border-color: #500; color: #f00; }
        img { max-width: 250px; border: 1px solid #0f0; margin: 10px 0; display: block; }
    </style>
</head>
<body>

    <div id="status">مزامنة الترددات الهندسية...</div>
    <div id="global-tick">0</div>

    <div id="chat-display"></div>

    <div class="input-area">
        <input type="text" id="userInput" placeholder="بث نبضات رقمية عبر الفجوة والتدفق...">
        <br>
        <button id="sendBtn">بث تردد 1001</button>
        <button id="fileBtn">بث تردد 465586</button>
        <button id="clearBtn" class="del-btn">تصفير السيرفر</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD4XkZaqv7_c-uiUFc2NvZEFyQUapirz-Y",
            authDomain: "setouchi-it.firebaseapp.com",
            databaseURL: "https://setouchi-it-default-rtdb.europe-west1.firebasedatabase.app/",
            projectId: "setouchi-it",
            storageBucket: "setouchi-it.appspot.com",
            messagingSenderId: "456612217542",
            appId: "1:456612217542:web:51d963523b1306e0bf4dc7"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const syncRef = ref(db, "time/sync");
        const streamRef = ref(db, "temporal/stream");
        const heartbeatRef = ref(db, "temporal/heartbeat");

        const machineEncoder = new TextEncoder();
        const machineDecoder = new TextDecoder();

        // --- 1. ضغط البيانات (لتقليص الملفات) ---
        async function compressData(data) {
            const stream = new Blob([data]).stream();
            const compressedStream = stream.pipeThrough(new CompressionStream("gzip"));
            const response = new Response(compressedStream);
            return new Uint8Array(await response.arrayBuffer());
        }

        async function decompressData(data) {
            const stream = new Blob([data]).stream();
            const decompressedStream = stream.pipeThrough(new DecompressionStream("gzip"));
            const response = new Response(decompressedStream);
            return new Uint8Array(await response.arrayBuffer());
        }

        // --- 2. العداد والنبض (Gap Logic) ---
        let counter = 1;
        let suppressedValue = null;
        let currentTick = 0;

        onValue(syncRef, snap => { if(snap.exists()) currentTick = snap.val(); document.getElementById("global-tick").textContent = currentTick; });
        setInterval(() => { set(syncRef, (currentTick % 10) + 1); }, 1000);

        setInterval(() => {
            if (counter > 255) counter = 1;
            if (counter === suppressedValue) { suppressedValue = null; } 
            else { set(heartbeatRef, counter); }
            counter++;
        }, 200);

        function triggerGap(text) {
            text.split("").forEach((char, idx) => {
                setTimeout(() => { suppressedValue = char.charCodeAt(0); }, idx * 1200);
            });
        }

        // --- 3. محرك الإرسال (Pulse Stream) ---
        async function sendPulseStream(rawData, fCode) {
            const compressed = await compressData(rawData);
            const CHUNK_SIZE = 64 * 1024;
            const total = Math.ceil(compressed.length / CHUNK_SIZE);

            for (let i = 0; i < total; i++) {
                const chunk = compressed.slice(i * CHUNK_SIZE, (i + 1) * CHUNK_SIZE);
                const pulsePath = `${fCode}/${Date.now()}_${i}`;
                await set(ref(db, `temporal/stream/${pulsePath}`), {
                    d: Array.from(chunk).map(b => b ^ 0x0F),
                    sz: total
                });
            }
        }

        // --- 4. تنفيذ الترددات ---
        document.getElementById("sendBtn").onclick = () => {
            const val = document.getElementById("userInput").value;
            if(!val) return;
            triggerGap(val);
            sendPulseStream(machineEncoder.encode(val), 1001);
            document.getElementById("userInput").value = "";
        };

        document.getElementById("fileBtn").onclick = () => {
            const input = document.createElement('input'); input.type = 'file';
            input.onchange = e => {
                const reader = new FileReader();
                reader.onload = (evt) => { sendPulseStream(new Uint8Array(evt.target.result), 465586); };
                reader.readAsArrayBuffer(e.target.files[0]);
            };
            input.click();
        };

        // --- 5. محرك الاستقبال وإعادة التجميع ---
        onValue(streamRef, async (snap) => {
            const display = document.getElementById("chat-display");
            if (!snap.exists()) return;
            const freqs = snap.val();

            for (let fCode in freqs) {
                const pulses = freqs[fCode];
                const keys = Object.keys(pulses).sort();
                const totalNeeded = pulses[keys[0]].sz;

                if (keys.length === totalNeeded) {
                    let chunks = [];
                    keys.forEach(k => { chunks.push(new Uint8Array(pulses[k].d.map(b => b ^ 0x0F))); });
                    
                    let merged = new Uint8Array(chunks.reduce((a, c) => a + c.length, 0));
                    let offset = 0;
                    chunks.forEach(c => { merged.set(c, offset); offset += c.length; });

                    const finalData = await decompressData(merged);
                    const container = document.createElement("div");
                    container.style.borderBottom = "1px solid #111";

                    if (parseInt(fCode) === 1001) {
                        container.textContent = machineDecoder.decode(finalData);
                    } else if (parseInt(fCode) === 465586) {
                        const url = URL.createObjectURL(new Blob([finalData]));
                        container.innerHTML = `<img src="${url}">`;
                    }
                    display.appendChild(container);
                    display.scrollTop = display.scrollHeight;
                }
            }
        });

        let lastH = 0;
        onValue(heartbeatRef, snap => {
            let curr = snap.val();
            if (curr === lastH + 2) {
                document.getElementById("chat-display").innerHTML += `<div style="color:#0ff;">[GAP]: ${String.fromCharCode(lastH+1)}</div>`;
            }
            lastH = curr;
        });

        document.getElementById("clearBtn").onclick = () => { if(confirm("تصفير؟")) { remove(ref(db, "temporal")); } };
    </script>
</body>
</html>

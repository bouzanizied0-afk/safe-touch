<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>â³ Temporal Pulse - Pro Edition</title>
    <style>
        body { background: #000; color: #0f0; font-family: 'Courier New', monospace; text-align: center; padding: 10px; margin: 0; }
        #global-tick { font-size: 40px; color: #0f0; text-shadow: 0 0 10px #0f0; margin: 10px; }
        #chat-display { 
            width: 95%; max-width: 700px; height: 400px; 
            border: 1px solid #003300; margin: 15px auto; 
            background: #050505; overflow-y: auto; padding: 15px;
            text-align: right; border-radius: 8px; box-shadow: inset 0 0 20px #000;
        }
        .input-area { margin-top: 10px; background: #0a0a0a; padding: 15px; border-top: 1px solid #003300; }
        input[type=text] { 
            width: 80%; padding: 12px; background: #000; 
            border: 1px solid #0f0; color: #0f0; outline: none; margin-bottom: 10px;
        }
        button { padding: 10px 20px; background: #001a00; color: #0f0; border: 1px solid #0f0; cursor: pointer; font-weight: bold; transition: 0.3s; }
        button:hover { background: #00ff00; color: #000; }
        .del-btn { border-color: #500; color: #f00; }
        img { max-width: 250px; border: 1px solid #0f0; margin: 10px 0; display: block; }
        .pulse-meta { font-size: 10px; color: #444; }
    </style>
</head>
<body>

    <div id="status">Ø¬Ø§Ø±ÙŠ Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ù‡Ù†Ø¯Ø³ÙŠØ©...</div>
    <div id="global-tick">0</div>

    <div id="chat-display"></div>

    <div class="input-area">
        <input type="text" id="userInput" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„ØªØ´ÙÙŠØ±Ù‡Ø§ ÙˆÙ†Ø´Ø±Ù‡Ø§ ÙƒÙ†Ø¨Ø¶Ø§Øª...">
        <br>
        <button id="sendBtn">Ø¥Ø±Ø³Ø§Ù„ Ù†Øµ (Chunked + Gap)</button>
        <button id="fileBtn">Ø±ÙØ¹ Ù…Ù„Ù (Raw Binary)</button>
        <button id="clearBtn" class="del-btn">ØªØµÙÙŠØ± Ø§Ù„Ø³ÙŠØ±ÙØ±</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, push, onValue, remove, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD4XkZaqv7_c-uiUFc2NvZEFyQUapirz-Y",
            authDomain: "setouchi-it.firebaseapp.com",
            databaseURL: "https://setouchi-it-default-rtdb.europe-west1.firebasedatabase.app/",
            projectId: "setouchi-it",
            storageBucket: "setouchi-it.appspot.com",
            messagingSenderId: "456612217542",
            appId: "1:456612217542:web:51d963523b1306e0bf4dc7"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const syncRef = ref(db, "time/sync");
        const pulseRef = ref(db, "temporal/v2_pulses");
        const heartbeatRef = ref(db, "temporal/heartbeat"); // Ù…Ø³Ø§Ø± Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¯ÙˆØ±ÙŠ

        const machineEncoder = new TextEncoder();
        const machineDecoder = new TextDecoder();

        // --- 1. Ù†Ø¸Ø§Ù… Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¯ÙˆØ±ÙŠ ÙˆØ§Ù„Ø­Ø°Ù (Logic Gap) ---
        let counter = 1;
        let suppressedValue = null;
        let currentTick = 0;

        // Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¹Ø§Ù…
        onValue(syncRef, snap => { if(snap.exists()) currentTick = snap.val(); document.getElementById("global-tick").textContent = currentTick; });
        setInterval(() => { set(syncRef, (currentTick % 10) + 1); }, 1000);

        // Ù…Ø­Ø±Ùƒ Ø§Ù„Ù†Ø¨Ø¶ Ø§Ù„Ù…Ø³ØªÙ…Ø± (Ø§Ù„Ù‚Ù„Ø¹Ø©)
        setInterval(() => {
            if (counter > 255) counter = 1;
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø±Ù‚Ù… Ù‡Ùˆ "Ø§Ù„Ù…Ø­Ø°ÙˆÙ"ØŒ Ù†Ø³ÙƒØª ÙˆÙ„Ø§ Ù†Ø±Ø³Ù„ Ù„Ù„Ø³ÙŠØ±ÙØ±
            if (counter === suppressedValue) {
                console.log("Gap Created at:", counter);
                suppressedValue = null; 
            } else {
                set(heartbeatRef, counter);
            }
            counter++;
        }, 200); // Ø³Ø±Ø¹Ø© Ø§Ù„Ù†Ø¨Ø¶

        // Ø¯Ø§Ù„Ø© Ø­Ø°Ù Ø§Ù„Ù†Ø¨Ø¶Ø§Øª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù†Øµ
        function triggerGap(text) {
            let delay = 0;
            text.split("").forEach(char => {
                setTimeout(() => {
                    suppressedValue = char.charCodeAt(0);
                }, delay);
                delay += 1200; // ÙˆÙ‚Øª ÙƒØ§ÙÙ Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø¯ÙˆØ±Ø© Ø§Ù„Ø¹Ø¯Ø§Ø¯
            });
        }

        // --- 2. Ù…Ø­Ø±Ùƒ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù‡Ù†Ø¯Ø³ÙŠ (Chunks) ---
        async function sendDataEng(data, type, mime = "") {
            const CHUNK_SIZE = 2048;
            const baseId = Date.now();
            for (let i = 0; i < data.length; i += CHUNK_SIZE) {
                const chunk = data.slice(i, i + CHUNK_SIZE);
                const obfuscated = Array.from(chunk).map(b => b ^ 0x0F); 
                await push(pulseRef, {
                    d: obfuscated, idx: i / CHUNK_SIZE, id: baseId,
                    t: type, m: mime, ts: serverTimestamp()
                });
            }
        }

        // --- 3. Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠØ© Ù„Ù„Ø£Ø²Ø±Ø§Ø± ---
        document.getElementById("sendBtn").onclick = () => {
            const val = document.getElementById("userInput").value;
            if(!val) return;
            
            // ØªÙ†ÙÙŠØ° Ø§Ù„Ø·Ø±ÙŠÙ‚ØªÙŠÙ† Ù…Ø¹Ø§Ù‹
            sendDataEng(machineEncoder.encode(val), "text"); // Ø¥Ø±Ø³Ø§Ù„ ØµØ±ÙŠØ­ Ù…Ø´ÙØ±
            triggerGap(val);                                // Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø¨Ø± Ø§Ù„ÙØ¬ÙˆØ© Ø§Ù„Ø²Ù…Ù†ÙŠØ©
            
            document.getElementById("userInput").value = "";
        };

        document.getElementById("fileBtn").onclick = () => {
            const input = document.createElement('input'); input.type = 'file';
            input.onchange = e => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (evt) => { sendDataEng(new Uint8Array(evt.target.result), "file", file.type); };
                reader.readAsArrayBuffer(file);
            };
            input.click();
        };

        // --- 4. Ù…Ø­Ø±Ùƒ Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬ ---
        
        // Ø£- Ù…Ø±Ø§Ù‚Ø¨ Ø§Ù„ÙØ¬ÙˆØ§Øª (Gap Monitor)
        let lastHValue = 0;
        onValue(heartbeatRef, (snapshot) => {
            const currentHValue = snapshot.val();
            // Ø§ÙƒØªØ´Ø§Ù Ø§Ù„Ù‚ÙØ²Ø© (Ø§Ù„Ø³ÙƒÙˆÙ† Ø§Ù„Ù…ØªØ¹Ù…Ø¯)
            if (currentHValue === lastHValue + 2 || (currentHValue === 1 && lastHValue === 254)) {
                const char = String.fromCharCode(lastHValue + 1);
                console.log("Detected Gap Char:", char);
                // ØªÙ…ÙŠÙŠØ² Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ÙØ¬ÙˆØ© Ø¨Ù„ÙˆÙ† Ù…Ø®ØªÙ„Ù ÙÙŠ Ø§Ù„Ø¹Ø±Ø¶
                const display = document.getElementById("chat-display");
                display.innerHTML += `<div style="color:#00ffff; font-size:12px;">[ØªÙ†Ø¨ÙŠÙ‡ Ù…Ø¹Ø§Ù„Ø¬]: Ø§ÙƒØªØ´Ø§Ù Ø³ÙƒÙˆÙ† Ø±Ù‚Ù…ÙŠ Ù„Ù„Ø­Ø±Ù (${char})</div>`;
            }
            lastHValue = currentHValue;
        });

        // Ø¨- Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ù†Ø§Ø¡ Ø§Ù„ÙƒØªÙ„ (Reconstruction)
        onValue(pulseRef, (snapshot) => {
            const display = document.getElementById("chat-display");
            display.innerHTML = "";
            if (!snapshot.exists()) return;
            const pulses = Object.values(snapshot.val());
            const groups = {};
            pulses.forEach(p => {
                if(!groups[p.id]) groups[p.id] = { type: p.t, mime: p.m, chunks: [] };
                const original = p.d.map(b => b ^ 0x0F);
                groups[p.id].chunks.push({ idx: p.idx, data: original });
            });
            Object.keys(groups).sort().forEach(id => {
                const group = groups[id];
                group.chunks.sort((a, b) => a.idx - b.idx);
                let totalLength = group.chunks.reduce((acc, c) => acc + c.data.length, 0);
                const finalArray = new Uint8Array(totalLength);
                let offset = 0;
                group.chunks.forEach(c => { finalArray.set(c.data, offset); offset += c.data.length; });
                const container = document.createElement("div");
                container.style.borderBottom = "1px solid #001100";
                container.style.padding = "5px";
                if (group.type === "text") {
                    container.textContent = machineDecoder.decode(finalArray);
                } else {
                    const blob = new Blob([finalArray], { type: group.mime });
                    const url = URL.createObjectURL(blob);
                    if (group.mime.startsWith("image/")) {
                        const img = document.createElement("img"); img.src = url; container.appendChild(img);
                    } else {
                        container.innerHTML = `<a href="${url}" download="file_${id}" style="color:#0f0;">ğŸ“‚ Ù…Ù„Ù Ù…Ø³ØªØ¹Ø§Ø¯</a>`;
                    }
                }
                display.appendChild(container);
            });
            display.scrollTop = display.scrollHeight;
        });

        document.getElementById("clearBtn").onclick = () => { if(confirm("Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ù†Ø¨Ø¶Ø§ØªØŸ")) { remove(pulseRef); remove(heartbeatRef); } };
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>â³ Temporal Chat + Full Media + Encoder</title>
<style>
body {
  background:#000;
  color:#0f0;
  font-family: monospace;
  text-align:center;
  padding-top:20px;
}
#minute {
  font-size:64px;
  margin:20px;
}
#chat {
  font-size:28px;
  color:#ff0;
  margin:20px auto;
  width:80%;
  max-height:400px;
  overflow-y:auto;
  text-align:left;
}
input[type=text] {
  width:50%;
  font-size:18px;
  padding:8px;
}
button {
  font-size:16px;
  padding:8px 16px;
  margin:5px;
  background:#003300;
  color:#0f0;
  border:1px solid #0f0;
}
img, video {
  max-width: 80%;
  margin:5px 0;
  display:block;
}
</style>
</head>
<body>

<h2>â³ Ø¯Ø±Ø¯Ø´Ø© Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø²Ù…Ù† Ù…Ø¹ ÙˆØ³Ø§Ø¦Ø· ÙƒØ§Ù…Ù„Ø©</h2>

<div id="minute">1</div>
<div id="chat"></div>

<input id="messageInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§">
<button onclick="sendMessage()">Ø¥Ø±Ø³Ø§Ù„ Ù†Øµ</button>
<button onclick="sendFile()">Ø¥Ø±Ø³Ø§Ù„ Ù…Ù„Ù</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, push, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
import { initEncoder, reserveChar, startTicker } from "./time-encoder.js";
import { initKeyboardCapture } from "./keyboard-capture-multilang.js";

// ğŸ” Ø¥Ø¹Ø¯Ø§Ø¯ Firebase
const firebaseConfig = {
  apiKey: "AIzaSyD4XkZaqv7_c-uiUFc2NvZEFyQUapirz-Y",
  authDomain: "setouchi-it.firebaseapp.com",
  databaseURL: "https://setouchi-it-default-rtdb.europe-west1.firebasedatabase.app/",
  projectId: "setouchi-it",
  storageBucket: "setouchi-it.appspot.com",
  messagingSenderId: "456612217542",
  appId: "1:456612217542:web:51d963523b1306e0bf4dc7"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const chatRef = ref(db, "temporal/chat");
const filesRef = ref(db, "temporal/files");

// âš™ï¸ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ±Ù…ÙŠØ² ÙˆØ§Ù„Ø¹Ø¯Ø§Ø¯
initEncoder(db, "temporal/nano");
startTicker();

// Ø±Ø¨Ø· Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø¨Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ù…ØªØ¹Ø¯Ø¯Ø© Ø§Ù„Ù„ØºØ§Øª
const input = document.getElementById("messageInput");
initKeyboardCapture(input);

// ===== IndexedDB Ù„Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ =====
let dbIndexed;
const request = indexedDB.open("TemporalChatDB",1);
request.onupgradeneeded = e => {
  dbIndexed = e.target.result;
  if(!dbIndexed.objectStoreNames.contains("messages")){
    dbIndexed.createObjectStore("messages",{keyPath:"nano"});
  }
  if(!dbIndexed.objectStoreNames.contains("files")){
    dbIndexed.createObjectStore("files",{keyPath:"nano"});
  }
};
request.onsuccess = e => {
  dbIndexed = e.target.result;
  displayMessages();
};

// ===== Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¯ÙˆØ±ÙŠ Ù„Ù„Ø¹Ø±Ø¶ 1â†’10 =====
let tick = 1;
const minuteDiv = document.getElementById("minute");

setInterval(()=>{
  tick++;
  if(tick>10) tick=1;
  minuteDiv.textContent = tick;
},600); // Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ù„Ù„Ø¹Ø±Ø¶ ÙÙ‚Ø·

// ===== Ø¥Ø±Ø³Ø§Ù„ Ù†Øµ Ù…Ø¨Ø§Ø´Ø± Ù…Ø¹ ØªØ®Ø²ÙŠÙ†Ù‡ Ù…Ø­Ù„ÙŠÙ‹Ø§ ÙˆØ¨Ø­Ø¬Ø² ÙƒÙ„ Ø­Ø±Ù Ù„Ù„Ù†Ø§Ù†Ùˆ =====
window.sendMessage = ()=>{
  const text = input.value.trim();
  if(!text) return;
  const nano = Date.now();

  // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø®Ø§Ø¯Ù…
  push(chatRef, {type:'text', text, nano});
  storeMessageLocal({type:'text', text, nano});

  // Ø­Ø¬Ø² ÙƒÙ„ Ø­Ø±Ù Ù„Ù„Ù†Ø§Ù†Ùˆ
  for(const char of text){
    reserveChar(char);
  }

  input.value="";
};

// ===== Ø¥Ø±Ø³Ø§Ù„ Ù…Ù„Ù Ù…Ø¨Ø§Ø´Ø± Ù…Ø¹ ØªØ®Ø²ÙŠÙ†Ù‡ Ù…Ø­Ù„ÙŠÙ‹Ø§ =====
window.sendFile = ()=>{
  const fileInput = document.createElement("input");
  fileInput.type="file";
  fileInput.onchange = async e=>{
    const file = e.target.files[0];
    if(!file) return;

    const chunkSize = 5*1024*1024; // 5 Ù…ÙŠØºØ§ Ù„ÙƒÙ„ chunk
    let offset = 0;

    while(offset < file.size){
      const slice = file.slice(offset, offset + chunkSize);
      const arrayBuffer = await slice.arrayBuffer();
      const nano = Date.now();

      push(filesRef, {
        fileName: file.name,
        type: file.type,
        chunk: arrayBuffer,
        nano
      });

      storeFileLocal({
        fileName: file.name,
        type: file.type,
        chunk: arrayBuffer,
        nano
      });

      offset += chunkSize;
    }
  };
  fileInput.click();
};

// ===== Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙˆØ§Ù„Ù…Ù„ÙØ§Øª Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù… =====
onValue(chatRef, snap => displayMessages());
onValue(filesRef, snap => displayMessages());

// ===== Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙˆØ§Ù„Ù…Ù„ÙØ§Øª =====
function displayMessages(){
  const chat = document.getElementById("chat");
  chat.innerHTML="";
  if(!dbIndexed) return;

  // Ø§Ù„Ù†ØµÙˆØµ
  const tx=dbIndexed.transaction("messages","readonly");
  const store=tx.objectStore("messages");
  store.openCursor().onsuccess=e=>{
    const cursor=e.target.result;
    if(cursor){
      const div=document.createElement("div");
      div.textContent=cursor.value.text;
      chat.appendChild(div);
      cursor.continue();
    }
  };

  // Ø§Ù„Ù…Ù„ÙØ§Øª
  const ftx=dbIndexed.transaction("files","readonly");
  const fstore=ftx.objectStore("files");
  fstore.openCursor().onsuccess=e=>{
    const cursor=e.target.result;
    if(cursor){
      const div=document.createElement("div");
      if(cursor.value.type.startsWith("image/")){
        const img=document.createElement("img");
        img.src=URL.createObjectURL(new Blob([cursor.value.chunk]));
        div.appendChild(img);
      } else if(cursor.value.type.startsWith("video/")){
        const vid=document.createElement("video");
        vid.src=URL.createObjectURL(new Blob([cursor.value.chunk]));
        vid.controls=true;
        div.appendChild(vid);
      } else {
        div.textContent=`[Ù…Ù„Ù] ${cursor.value.fileName}`;
      }
      chat.appendChild(div);
      cursor.continue();
    }
  };
}

// ===== Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ =====
function storeMessageLocal(msg){
  if(!dbIndexed) return;
  const tx=dbIndexed.transaction("messages","readwrite");
  tx.objectStore("messages").put(msg);
}

function storeFileLocal(file){
  if(!dbIndexed) return;
  const tx=dbIndexed.transaction("files","readwrite");
  tx.objectStore("files").put(file);
}

// ===== ØªØ­Ù…ÙŠÙ„ Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„ =====
function loadLocalMessages(){
  displayMessages();
}

</script>

</body>
</html>

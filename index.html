<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>â³ Temporal Chat + Full Media</title>
<style>
body {
  background:#000;
  color:#0f0;
  font-family: monospace;
  text-align:center;
  padding-top:20px;
}
#minute {
  font-size:64px;
  margin:20px;
}
#chat {
  font-size:28px;
  color:#ff0;
  margin:20px auto;
  width:80%;
  max-height:400px;
  overflow-y:auto;
  text-align:left;
}
input[type=text] {
  width:50%;
  font-size:18px;
  padding:8px;
}
button {
  font-size:16px;
  padding:8px 16px;
  margin:5px;
  background:#003300;
  color:#0f0;
  border:1px solid #0f0;
}
img, video {
  max-width: 80%;
  margin:5px 0;
  display:block;
}
</style>
</head>
<body>

<h2>â³ Ø¯Ø±Ø¯Ø´Ø© Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø²Ù…Ù† Ù…Ø¹ ÙˆØ³Ø§Ø¦Ø· ÙƒØ§Ù…Ù„Ø©</h2>

<div id="minute">1</div>
<div id="chat"></div>

<input id="messageInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§">
<button onclick="sendMessage()">Ø¥Ø±Ø³Ø§Ù„ Ù†Øµ</button>
<button onclick="sendFile()">Ø¥Ø±Ø³Ø§Ù„ Ù…Ù„Ù</button>
<button id="clearBtn">ğŸ—‘ Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙˆØ§Ù„Ù…Ù„ÙØ§Øª</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, push, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

// ğŸ” Ø¥Ø¹Ø¯Ø§Ø¯ Firebase
const firebaseConfig = {
  apiKey: "AIzaSyD4XkZaqv7_c-uiUFc2NvZEFyQUapirz-Y",
  authDomain: "setouchi-it.firebaseapp.com",
  databaseURL: "https://setouchi-it-default-rtdb.europe-west1.firebasedatabase.app/",
  projectId: "setouchi-it",
  storageBucket: "setouchi-it.appspot.com",
  messagingSenderId: "456612217542",
  appId: "1:456612217542:web:51d963523b1306e0bf4dc7"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const chatRef = ref(db, "temporal/chat");
const filesRef = ref(db, "temporal/files");

// ===== IndexedDB Ù„Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ =====
let dbIndexed;
const request = indexedDB.open("TemporalChatDB",1);
request.onupgradeneeded = e => {
  dbIndexed = e.target.result;
  if(!dbIndexed.objectStoreNames.contains("messages")){
    dbIndexed.createObjectStore("messages",{keyPath:"nano"});
  }
  if(!dbIndexed.objectStoreNames.contains("files")){
    dbIndexed.createObjectStore("files",{keyPath:"nano"});
  }
};
request.onsuccess = e => {
  dbIndexed = e.target.result;
  displayMessages();
};

// ===== Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¯ÙˆØ±ÙŠ 1â†’10 =====
let tick = 1;
const minuteDiv = document.getElementById("minute");
const queue = [];
const fileQueue = [];

setInterval(()=>{
  tick++;
  if(tick>10) tick=1;
  minuteDiv.textContent = tick;

  // Ø¥Ø±Ø³Ø§Ù„ Ù†ØµÙˆØµ
  if(queue.length>0){
    const msg = queue.shift();
    const nano = Date.now();
    push(chatRef,{type:'text',text:msg,nano});
    storeMessageLocal({type:'text',text:msg,nano});
  }

  // Ø¥Ø±Ø³Ø§Ù„ Ù…Ù„ÙØ§Øª
  if(fileQueue.length>0){
    const item = fileQueue.shift();
    const reader = new FileReader();
    reader.onload = e=>{
      push(filesRef,{
        fileName:item.fileName,
        type:item.type,
        chunk:e.target.result,
        nano:Date.now()
      });
      storeFileLocal({
        fileName:item.fileName,
        type:item.type,
        chunk:e.target.result,
        nano:Date.now()
      });
    };
    reader.readAsArrayBuffer(item.chunk);
  }

},600);

// ===== Ø¥Ø±Ø³Ø§Ù„ Ù†Øµ =====
window.sendMessage = ()=>{
  const input = document.getElementById("messageInput");
  const text = input.value.trim();
  if(!text) return;
  queue.push(text);
  input.value="";
};

// ===== Ø¥Ø±Ø³Ø§Ù„ Ù…Ù„Ù =====
window.sendFile = ()=>{
  const input = document.createElement("input");
  input.type="file";
  input.onchange = e=>{
    const file = e.target.files[0];
    if(!file) return;
    const chunkSize = 5*1024*1024; // ØªÙ‚Ø³ÙŠÙ… Ø¯Ø§Ø®Ù„ÙŠ (5 Ù…ÙŠØºØ§)
    let offset = 0;
    while(offset<file.size){
      const slice = file.slice(offset,offset+chunkSize);
      fileQueue.push({chunk:slice,fileName:file.name,type:file.type});
      offset+=chunkSize;
    }
  };
  input.click();
};

// ===== Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù… =====
onValue(chatRef,snap=>{displayMessages();});
onValue(filesRef,snap=>{displayMessages();});

// ===== Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙˆØ§Ù„Ù…Ù„ÙØ§Øª =====
function displayMessages(){
  const chat = document.getElementById("chat");
  chat.innerHTML="";
  if(!dbIndexed) return;

  const tx=dbIndexed.transaction("messages","readonly");
  const store=tx.objectStore("messages");
  store.openCursor().onsuccess=e=>{
    const cursor=e.target.result;
    if(cursor){
      const div=document.createElement("div");
      div.textContent=cursor.value.text;
      chat.appendChild(div);
      cursor.continue();
    }
  };
   
  const ftx=dbIndexed.transaction("files","readonly");
  const fstore=ftx.objectStore("files");
  fstore.openCursor().onsuccess=e=>{
    const cursor=e.target.result;
    if(cursor){
      const div=document.createElement("div");
      if(cursor.value.type.startsWith("image/")){
        const img=document.createElement("img");
        img.src=URL.createObjectURL(new Blob([cursor.value.chunk]));
        div.appendChild(img);
      } else if(cursor.value.type.startsWith("video/")){
        const vid=document.createElement("video");
        vid.src=URL.createObjectURL(new Blob([cursor.value.chunk]));
        vid.controls=true;
        div.appendChild(vid);
      } else {
        div.textContent=`[Ù…Ù„Ù] ${cursor.value.fileName}`;
      }
      chat.appendChild(div);
      cursor.continue();
    }
  };
}

// ===== Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ =====
function storeMessageLocal(msg){
  if(!dbIndexed) return;
  const tx=dbIndexed.transaction("messages","readwrite");
  tx.objectStore("messages").put(msg);
}

function storeFileLocal(file){
  if(!dbIndexed) return;
  const tx=dbIndexed.transaction("files","readwrite");
  tx.objectStore("files").put(file);
}

// ===== ØªØ­Ù…ÙŠÙ„ Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„ =====
function loadLocalMessages(){
  displayMessages();
}
document.getElementById("clearBtn").addEventListener("click", ()=> {
  if(!dbIndexed) return;
  
  // Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
  const txMsg = dbIndexed.transaction("messages","readwrite");
  txMsg.objectStore("messages").clear();

  // Ø­Ø°Ù Ø§Ù„Ù…Ù„ÙØ§Øª
  const txFiles = dbIndexed.transaction("files","readwrite");
  txFiles.objectStore("files").clear();

  // Ù…Ø³Ø­ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙˆØ±Ø§Ù‹
  document.getElementById("chat").innerHTML = "";
});
</script>

</body>
</html>


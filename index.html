<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>IT Temporal â€“ Ø¨ÙˆØ§Ø¨Ø© Ø²Ù…Ù†ÙŠØ© Ø°Ø§ØªÙŠØ© Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©</title>
<style>
body { background:#0b0b0b; color:#0f0; font-family:monospace; text-align:center; padding:20px }
#time { font-size:48px; margin:20px }
input,button { font-size:16px; padding:6px }
#errors { background:#000; border-left:3px solid #f00; color:#f00; max-height:160px; overflow:auto; padding:10px; text-align:left }
#status { color:#0ff; margin-top:10px }
</style>
</head>
<body>

<h2>â³ IT Temporal</h2>
<div id="time">--:--:--</div>

<div>
ÙØ±Ù‚ Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚:
<input id="offsetInput" type="number" value="0">
<button onclick="applyOffset()">ØªØ·Ø¨ÙŠÙ‚</button>
</div>

<div id="status">ğŸ”Œ Ø§Ù„Ø§ØªØµØ§Ù„â€¦</div>

<h3>Ø³Ø¬Ù„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡</h3>
<div id="errors"></div>

<script type="module">
/* ========= Firebase ========= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, set, onValue, off } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyD4XkZaqv7_c-uiUFc2NvZEFyQUapirz-Y",
  authDomain: "setouchi-it.firebaseapp.com",
  databaseURL: "https://setouchi-it-default-rtdb.firebaseio.com",
  projectId: "setouchi-it",
  storageBucket: "setouchi-it.appspot.com",
  messagingSenderId: "456612217542",
  appId: "1:456612217542:web:51d963523b1306e0bf4dc7"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const timeRef = ref(db, "portal/offset");

/* ========= AGENT 1: HUNTER ========= */
function logError(msg) {
  const e = document.createElement("div");
  e.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
  document.getElementById("errors").appendChild(e);
  console.error(msg);
}

/* ========= AGENT 2: HEALER ========= */
function heal(reason) {
  logError("ğŸ› ï¸ ØµÙŠØ§Ù†Ø© Ø°Ø§ØªÙŠØ©: " + reason);
  try {
    off(timeRef);
    subscribe(); // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ
  } catch(e) {
    logError("âŒ ÙØ´Ù„ Ø§Ù„ØµÙŠØ§Ù†Ø©: " + e.message);
  }
}

/* ========= AGENT 3: WATCHER ========= */
let lastUpdate = Date.now();
setInterval(() => {
  if (Date.now() - lastUpdate > 3000) {
    heal("Ø§Ù†Ù‚Ø·Ø§Ø¹ Ø£Ùˆ Ø¬Ù…ÙˆØ¯ ÙÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«");
  }
}, 1500);

/* ========= CORE ========= */
let offsetMinutes = 0;

function subscribe() {
  onValue(timeRef, snap => {
    if (!snap.exists()) return;
    offsetMinutes = snap.val();
    document.getElementById("offsetInput").value = offsetMinutes;
    document.getElementById("status").textContent = "â›“ï¸ Ù…ØªØ²Ø§Ù…Ù†";
    lastUpdate = Date.now();
  }, err => {
    logError("âŒ Firebase: " + err.message);
    heal("Ø®Ø·Ø£ Ø§ØªØµØ§Ù„");
  });
}
subscribe();

window.applyOffset = () => {
  const val = Number(offsetInput.value);
  set(timeRef, val).catch(e => logError("âŒ ÙƒØªØ§Ø¨Ø©: " + e.message));
};

/* ========= RENDER ========= */
setInterval(() => {
  const now = new Date(Date.now() + offsetMinutes * 60000);
  const h = String(now.getHours()).padStart(2,'0');
  const m = String(now.getMinutes()).padStart(2,'0');
  const s = String(now.getSeconds()).padStart(2,'0');
  document.getElementById("time").textContent = `${h}:${m}:${s}`;
}, 1000);

/* ========= GLOBAL TRAPS ========= */
window.onerror = (m, s, l) => logError(`JS: ${m} (Ø³Ø·Ø± ${l})`);
window.onunhandledrejection = e => logError("Promise: " + e.reason);

</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>⏳ البوابة الزمنية المركزية</title>
<style>
body {
  background:#000;
  color:#0f0;
  font-family: monospace;
  text-align:center;
  padding-top:50px;
}
#time {
  font-size:48px;
  margin:20px 0;
}
input, button {
  font-size:18px;
  padding:6px;
}
#status {
  color:#0ff;
  margin-top:15px;
}
</style>
</head>
<body>

<h1>⏳ البوابة الزمنية</h1>
<div id="time">--:--:--</div>

<div>
  ⏱️ فرق الدقائق:
  <input id="offsetInput" type="number" value="0">
  <button onclick="applyOffset()">تطبيق</button>
</div>

<div id="status">في انتظار المزامنة...</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyD4XkZaqv7_c-uiUFc2NvZEFyQUapirz-Y",
  authDomain: "setouchi-it.firebaseapp.com",
  databaseURL: "https://setouchi-it-default-rtdb.firebaseio.com",
  projectId: "setouchi-it",
  storageBucket: "setouchi-it.appspot.com",
  messagingSenderId: "456612217542",
  appId: "1:456612217542:web:51d963523b1306e0bf4dc7"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const timeRef = ref(db, "portalTime");

let offsetMinutes = 0;

// الاستماع المركزي (هذا هو القلب)
onValue(timeRef, snap => {
  if (!snap.exists()) return;
  const data = snap.val();
  offsetMinutes = data.offsetMinutes || 0;
  document.getElementById("offsetInput").value = offsetMinutes;
  document.getElementById("status").textContent = "⛓️ متزامن مع البوابة";
});

// تحديث العرض فقط (لا كتابة)
function renderTime() {
  const now = new Date();
  const adjusted = new Date(now.getTime() + offsetMinutes * 60000);

  const h = adjusted.getHours().toString().padStart(2,'0');
  const m = adjusted.getMinutes().toString().padStart(2,'0');
  const s = adjusted.getSeconds().toString().padStart(2,'0');

  document.getElementById("time").textContent = `${h}:${m}:${s}`;
}
setInterval(renderTime, 1000);

// الكتابة الوحيدة (تغيّر الجميع)
window.applyOffset = function () {
  const val = Number(document.getElementById("offsetInput").value);
  set(timeRef, {
    offsetMinutes: val,
    updatedAt: Date.now()
  });
};
</script>

</body>
</html>
